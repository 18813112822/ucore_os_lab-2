# Lab 2 实验报告

## 练习1：实现 first-fit 连续物理内存分配算法

简要实现过程：
- `default_init` 初始化链表，用原来的代码即可
- `default_init_memmap` 将一个空页块插入链表，用原来的代码即可
- `default_alloc_pages` 分配页块，从头开始搜索整个链表，直到找到为止，注意要把多余的部分重新插入回链表中原来的位置
- `default_free_pages` 释放页块，从头开始搜索整个链表直到找到一个合适的插入位置，然后将其插入，并判断链表中前后一项是否能合并

### 一个问题：你的first fit算法是否有进一步的改进空间

有。我们可以用任意一种平衡二叉查找树（BBST）来维护空闲块的关系，就可以将每次操作的时间复杂度从线性降到对数级别。


## 练习2：实现寻找虚拟地址对应的页表项

简要实现过程：
- 先用 `pgdir + PDX(la)` 求出页目录项（PDE）的地址
- 然后检查该PDE是否存在，如果不存在且不需要创建，就返回空指针
- 否则，分配一个页，设置其引用计数为1，并memset其内容，然后分配给该PDE
- 最后返回PTE的地址，即PDE所指的页的地址加上`PTX(la)`。

### 问题一：请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处。

PDE的高20位表示该PDE所分配的页的地址，低12位表示该PDE的各标记位。PTE同理。
对ucore来说，这样可以将地址和标记位存在一起，节省空间。

### 问题二：如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

硬件发生中断，打断当前程序的运行，跳转到中断向量表所指的相应的地址。


## 练习3：释放某虚地址所在的页并取消对应二级页表项的映射

简要实现过程：
- 先检查该PTE是否存在，如果不存在，直接返回
- 将该PTE所使用的页的引用计数减一，如果减到了零，则将该PTE所用的页释放掉
- 清空该PTE，并无效化相应的TLB项

### 问题一：数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

页表中的页目录项和页表项，都能通过`PTE_ADDR`和`pa2page`，对应到Page的某一项，其对应关系是先右移12位计算出页号，然后将页号作为下标得到Page数组中的某一项。

### 问题二：如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？

在分配页的时候，将物理地址与虚拟地址相同的页分配出来，可以通过问题一中的对应关系计算得到。


